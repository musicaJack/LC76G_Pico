# 系统架构

本页面详细介绍 LC76G_Pico 项目的整体系统架构和各个模块之间的关系。

## 系统概述

LC76G_Pico 是一个基于 Raspberry Pi Pico 的 GPS 跟踪系统，集成了 L76X GPS 模块和 ST7789 LCD 显示屏。系统架构采用模块化设计，清晰地分离了硬件驱动层和应用逻辑层，使得代码更易于维护和扩展。

## 架构图

```
┌───────────────────────────────────────────────┐
│                 应用层                         │
│ ┌─────────────────┐    ┌───────────────────┐  │
│ │   GPS 应用示例   │    │  GPS 显示屏应用   │  │
│ └─────────────────┘    └───────────────────┘  │
├───────────────────────────────────────────────┤
│                 服务层                         │
│ ┌─────────────────┐    ┌───────────────────┐  │
│ │ 坐标转换服务    │    │  数据处理服务     │  │
│ └─────────────────┘    └───────────────────┘  │
├───────────────────────────────────────────────┤
│                 驱动层                         │
│ ┌─────────────────┐    ┌───────────────────┐  │
│ │   GPS 驱动      │    │   LCD 驱动        │  │
│ └─────────────────┘    └───────────────────┘  │
├───────────────────────────────────────────────┤
│                 硬件抽象层                     │
│ ┌─────────────────┐    ┌───────────────────┐  │
│ │   UART 接口     │    │   SPI 接口        │  │
│ └─────────────────┘    └───────────────────┘  │
├───────────────────────────────────────────────┤
│                 硬件层                         │
│ ┌─────────────────┐    ┌───────────────────┐  │
│ │   Pico 微控制器 │    │  外设 (GPS/LCD)   │  │
│ └─────────────────┘    └───────────────────┘  │
└───────────────────────────────────────────────┘
```

## 层次结构

### 1. 硬件层

硬件层包括物理设备和电路连接：

- **Raspberry Pi Pico**: 作为主控制器，提供处理能力和 GPIO 接口
- **L76X GPS 模块**: 提供地理位置信息
- **ST7789 LCD 显示屏**: 提供图形显示功能
- **自开发定制主板**: 集成上述组件的基板

### 2. 硬件抽象层 (HAL)

硬件抽象层提供了与底层硬件通信的标准接口：

- **UART 接口**: 提供与 GPS 模块的通信接口
- **SPI 接口**: 提供与 LCD 显示屏的通信接口
- **GPIO 控制**: 管理引脚状态和功能

### 3. 驱动层

驱动层封装了对特定硬件设备的控制逻辑：

- **GPS 驱动**: 负责 GPS 模块的初始化、数据接收和解析
  - `vendor_gps_parser.c/h`: 解析 NMEA 语句和提取 GPS 信息
  
- **LCD 驱动**: 负责 LCD 显示屏的初始化和基本绘图功能
  - `st7789.c/h`: ST7789 控制器的基本操作
  - `st7789_hal.c/h`: ST7789 的硬件抽象层
  - `st7789_gfx.c/h`: 图形绘制功能

### 4. 服务层

服务层提供了特定领域的功能和数据处理：

- **坐标转换服务**: 实现不同坐标系统之间的转换
  - WGS-84 到 GCJ-02 (谷歌地图)转换
  - WGS-84 到 BD-09 (百度地图)转换
  
- **数据处理服务**: 处理和格式化 GPS 数据
  - NMEA 语句解析逻辑
  - 时间和日期格式化

### 5. 应用层

应用层是最终用户功能的实现：

- **GPS 应用示例**: 基本的 GPS 数据获取和处理示例
  - `vendor_gps_example.c`: 简单的 GPS 数据读取示例
  
- **GPS 显示屏应用**: 完整的 GPS 数据获取和显示功能
  - `vendor_gps_display.c`: 综合 GPS 和显示屏功能的示例

## 数据流

1. **GPS 数据流**:
   - GPS 模块接收卫星信号
   - 通过 UART 发送 NMEA 语句到 Pico
   - GPS 驱动解析 NMEA 数据
   - 服务层处理和转换坐标
   - 应用层显示或使用 GPS 数据

2. **显示数据流**:
   - 应用层组织显示内容
   - 调用图形服务绘制 UI 元素
   - LCD 驱动将图形数据转换为显示命令
   - 通过 SPI 将命令和数据发送到显示屏
   - 显示屏更新内容

## 组件交互

1. **GPS 模块与 Pico 的交互**:
   - 初始化: 配置 UART 通信参数
   - 数据传输: GPS 模块自动向 Pico 发送 NMEA 语句
   - 控制: Pico 可发送命令来控制 GPS 模块的工作模式

2. **LCD 显示屏与 Pico 的交互**:
   - 初始化: 配置 SPI 通信参数，发送初始化命令序列
   - 绘图: Pico 发送绘图命令和数据到显示屏
   - 控制: 可控制显示屏的背光、复位和显示方向

3. **应用与驱动层的交互**:
   - 应用层通过清晰定义的 API 调用驱动功能
   - 驱动层向应用层提供状态报告和数据回传

## 模块依赖关系

- **应用层依赖**:
  - GPS 显示屏应用依赖于 GPS 驱动和 LCD 驱动
  - GPS 应用示例仅依赖于 GPS 驱动

- **服务层依赖**:
  - 坐标转换服务不依赖其他模块
  - 数据处理服务依赖于 GPS 驱动提供的原始数据

- **驱动层依赖**:
  - GPS 驱动依赖于 UART HAL
  - LCD 驱动依赖于 SPI HAL 和 GPIO 控制

## 扩展性考虑

系统设计考虑了以下扩展点：

1. **添加新的传感器**:
   - 可以按照类似的分层结构添加新的传感器驱动
   - 只需开发对应的 HAL 和驱动层，然后在应用层集成

2. **支持不同的 GPS 模块**:
   - 可以实现新的 GPS 驱动，只要它提供相同的 API 接口
   - 通过配置选择使用哪个 GPS 驱动实现

3. **支持不同的显示技术**:
   - 可以添加不同的显示驱动，如 OLED 或 e-Paper
   - 保持图形服务层不变，只替换底层驱动

4. **添加通信功能**:
   - 可以集成 WiFi、蓝牙或其他通信模块
   - 为通信模块实现相应的 HAL 和驱动层

## 性能和资源优化

该架构在设计时考虑了 Pico 的资源限制：

1. **内存优化**:
   - 尽量使用静态分配而非动态内存
   - 使用共享缓冲区减少内存占用

2. **处理器优化**:
   - 关键路径使用轻量级算法
   - 避免频繁中断和复杂计算

3. **电源管理**:
   - 支持 GPS 模块的低功耗模式
   - 实现系统级的电源管理策略 